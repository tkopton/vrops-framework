<?xml version='1.0' encoding='UTF-8'?>
<workflow xmlns="http://vmware.com/vco/workflow" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://vmware.com/vco/workflow http://vmware.com/vco/workflow/Workflow-v4.xsd" root-name="item1" object-name="workflow:name=generic" id="5c075b6b-2173-4d1e-a660-03762762de74" version="0.0.13" api-version="6.0.0" allowed-operations="evf" restartMode="1" resumeFromFailedMode="0">
  <display-name><![CDATA[EBS iTOP VirtualMachine Create]]></display-name>
  <position y="50.0" x="100.0"/>
  <input>
    <param name="requestId" type="string"/>
    <param name="machine" type="Properties"/>
    <param name="virtualMachineAddOrUpdateProperties" type="Properties"/>
    <param name="virtualMachineEvent" type="string"/>
    <param name="lifecycleState" type="Properties"/>
    <param name="componentId" type="string"/>
    <param name="blueprintName" type="string"/>
    <param name="componentTypeId" type="string"/>
    <param name="endpointId" type="string"/>
    <param name="workflowNextState" type="string"/>
    <param name="virtualMachineDeleteProperties" type="Properties"/>
  </input>
  <attrib name="ipaddress" type="string" read-only="false">
    <value encoded="n"><![CDATA[]]></value>
  </attrib>
  <attrib name="nodeName" type="string" read-only="false">
    <value encoded="n"><![CDATA[]]></value>
  </attrib>
  <attrib name="domain" type="string" read-only="false">
    <value encoded="n"><![CDATA[]]></value>
  </attrib>
  <attrib name="host" type="vCAC:VCACHost" read-only="false">
    <value encoded="n"><![CDATA[dunes://service.dunes.ch/CustomSDKObject?id='3bf201d4-82ea-4fd6-98ad-c263aff375be'&dunesName='vCAC:VCACHost']]></value>
  </attrib>
  <attrib name="virtualMachineEntity" type="vCAC:Entity" read-only="false">
    <value encoded="n"><![CDATA[__NULL__]]></value>
  </attrib>
  <attrib name="cpuCount" type="string" read-only="false">
    <value encoded="n"><![CDATA[]]></value>
  </attrib>
  <attrib name="memory" type="string" read-only="false">
    <value encoded="n"><![CDATA[]]></value>
  </attrib>
  <attrib name="orgName" type="string" read-only="false">
    <value encoded="n"><![CDATA[My Company/Department]]></value>
    <description><![CDATA[Requester organization name]]></description>
  </attrib>
  <attrib name="hostname" type="string" read-only="false">
    <value encoded="n"><![CDATA[VMUG]]></value>
  </attrib>
  <workflow-item name="item0" type="end" end-mode="0">
    <position y="45.40909090909091" x="524.5"/>
  </workflow-item>
  <workflow-item name="item1" out-name="item2" type="task">
    <display-name><![CDATA[Get Property Values and log]]></display-name>
    <script encoded="false"><![CDATA[System.log("------List Properties------");
System.log("requestId: " + requestId);
System.log("machine.id: " + machine.get("id"))
System.log("machine.name: " + machine.get("name"))
System.log("machine.type: " + machine.get("type"))
System.log("machine.owner: " + machine.get("owner"))
System.log("machine.externalReference: " + machine.get("externalReference"))
//myprop = machine.get("properties");
//System.log("MyProperties: " + myprop.length)
System.log("virtualMachineEvent: " + virtualMachineEvent);
System.log("lifecycleState.event: " + lifecycleState.get("event"))
System.log("lifecycleState.phase: " + lifecycleState.get("phase"))
System.log("lifecycleState.state: " + lifecycleState.get("state"))
System.log("componentId: " + componentId);
System.log("blueprintName: " + blueprintName );
System.log("componentTypeId: " + componentTypeId);
System.log("endpointId: " + endpointId);
System.log("workflowNextState: " + workflowNextState);


var properties = new Properties();
properties.put("VirtualMachineID", machine.get("id"));


virtualMachineEntity = vCACEntityManager.readModelEntity(host.id, "ManagementModelEntities.svc", "VirtualMachines", properties, null);
var vmProperties = new Properties();

var virtualMachinePropertiesEntities = virtualMachineEntity.getLink(host, "VirtualMachineProperties");
for each (var virtualMachinePropertiesEntity in virtualMachinePropertiesEntities) {
	var propertyName = virtualMachinePropertiesEntity.getProperty("PropertyName");
	var propertyValue = virtualMachinePropertiesEntity.getProperty("PropertyValue");
	System.log("Found property " + propertyName + " = " + propertyValue);
	vmProperties.put(propertyName, propertyValue);
}
//domain = vmProperties.get("VirtualMachine.Network0.DnsSuffix")
nodeName = machine.get("name");
//hostname = machine.get("name") + "." + domain;
ipaddress = vmProperties.get("VirtualMachine.Network0.Address");
//netmask = vmProperties.get("VirtualMachine.Network0.SubnetMask");
//gateway = vmProperties.get("VirtualMachine.Network0.Gateway");
cpuCount = vmProperties.get("VirtualMachine.CPU.Count");
memory = vmProperties.get("VirtualMachine.Memory.Size");
]]></script>
    <in-binding>
      <bind name="requestId" type="string" export-name="requestId"/>
      <bind name="machine" type="Properties" export-name="machine"/>
      <bind name="virtualMachineAddOrUpdateProperties" type="Properties" export-name="virtualMachineAddOrUpdateProperties"/>
      <bind name="virtualMachineEvent" type="string" export-name="virtualMachineEvent"/>
      <bind name="lifecycleState" type="Properties" export-name="lifecycleState"/>
      <bind name="componentId" type="string" export-name="componentId"/>
      <bind name="blueprintName" type="string" export-name="blueprintName"/>
      <bind name="componentTypeId" type="string" export-name="componentTypeId"/>
      <bind name="endpointId" type="string" export-name="endpointId"/>
      <bind name="workflowNextState" type="string" export-name="workflowNextState"/>
      <bind name="virtualMachineDeleteProperties" type="Properties" export-name="virtualMachineDeleteProperties"/>
      <bind name="host" type="vCAC:VCACHost" export-name="host"/>
    </in-binding>
    <out-binding>
      <bind name="ipaddress" type="string" export-name="ipaddress"/>
      <bind name="nodeName" type="string" export-name="nodeName"/>
      <bind name="domain" type="string" export-name="domain"/>
      <bind name="hostname" type="string" explicitly-not-bound="true" export-name="NULL"/>
      <bind name="virtualMachineEntity" type="vCAC:Entity" export-name="virtualMachineEntity"/>
      <bind name="cpuCount" type="string" export-name="cpuCount"/>
      <bind name="memory" type="string" export-name="memory"/>
    </out-binding>
    <position y="55.40909090909091" x="204.5"/>
  </workflow-item>
  <workflow-item name="item2" out-name="item0" type="link" linked-workflow-id="6b085ecf-9654-48dd-a1c4-63bfddc0bbe5">
    <display-name><![CDATA[Create iTop Virtual Machine with additional values]]></display-name>
    <in-binding>
      <bind name="vmName" type="string" export-name="nodeName"/>
      <bind name="orgName" type="string" export-name="orgName">
        <description><![CDATA[Requester organization name]]></description>
      </bind>
      <bind name="virtualHostName" type="string" export-name="hostname"/>
      <bind name="cpu" type="string" export-name="cpuCount"/>
      <bind name="ram" type="string" export-name="memory"/>
      <bind name="ip" type="string" export-name="ipaddress"/>
    </in-binding>
    <out-binding>
      <bind name="statusCode" type="number" explicitly-not-bound="true">
        <description><![CDATA[Status code of the HTTP request]]></description>
      </bind>
      <bind name="contentLength" type="number" explicitly-not-bound="true">
        <description><![CDATA[Length of the request response]]></description>
      </bind>
      <bind name="headers" type="Properties" explicitly-not-bound="true">
        <description><![CDATA[Response headers]]></description>
      </bind>
      <bind name="contentAsString" type="string" explicitly-not-bound="true">
        <description><![CDATA[Response content as string]]></description>
      </bind>
      <bind name="fieldsArray" type="Array/string" explicitly-not-bound="true"/>
      <bind name="requestCode" type="string" explicitly-not-bound="true"/>
      <bind name="requestMessage" type="string" explicitly-not-bound="true"/>
      <bind name="vmId" type="string" explicitly-not-bound="true"/>
    </out-binding>
    <description><![CDATA[Creates new Request in the iTop helpdesk]]></description>
    <position y="55.40909090909091" x="344.5"/>
  </workflow-item>
  <presentation>
    <p-param name="requestId">
      <desc><![CDATA[requestId]]></desc>
    </p-param>
    <p-param name="machine">
      <desc><![CDATA[machine]]></desc>
    </p-param>
    <p-param name="virtualMachineAddOrUpdateProperties">
      <desc><![CDATA[virtualMachineAddOrUpdateProperties]]></desc>
    </p-param>
    <p-param name="virtualMachineEvent">
      <desc><![CDATA[virtualMachineEvent]]></desc>
    </p-param>
    <p-param name="lifecycleState">
      <desc><![CDATA[lifecycleState]]></desc>
    </p-param>
    <p-param name="componentId">
      <desc><![CDATA[componentId]]></desc>
    </p-param>
    <p-param name="blueprintName">
      <desc><![CDATA[blueprintName]]></desc>
    </p-param>
    <p-param name="componentTypeId">
      <desc><![CDATA[componentTypeId]]></desc>
    </p-param>
    <p-param name="endpointId">
      <desc><![CDATA[endpointId]]></desc>
    </p-param>
    <p-param name="workflowNextState">
      <desc><![CDATA[workflowNextState]]></desc>
    </p-param>
    <p-param name="virtualMachineDeleteProperties">
      <desc><![CDATA[virtualMachineDeleteProperties]]></desc>
    </p-param>
  </presentation>
</workflow>